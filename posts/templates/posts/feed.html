{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
  <h2>Home Feed</h2>
  {% for post in posts %}
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">{{ post.user.username }}</h5>
        <p class="card-text">{{ post.text }}</p>
        {% if post.image %}
          <img src="{{ post.image.url }}" class="img-fluid mb-2">
        {% endif %}
        <button class="btn btn-outline-primary btn-sm like-btn" data-post-id="{{ post.id }}">
          Like (<span class="like-count">{{ post.likes.count }}</span>)
        </button>
        <a href="{% url 'post_detail' post.id %}" class="btn btn-link btn-sm">Comments ({{ post.comments.count }})</a>
        <small class="text-muted float-end">{{ post.timestamp }}</small>
      </div>
    </div>
  {% empty %}
    <p>No posts yet.</p>
  {% endfor %}
</div>
<script>
document.querySelectorAll('.like-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const postId = this.getAttribute('data-post-id');
    fetch(`/posts/like/${postId}/`, {method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}})
      .then(response => response.json())
      .then(data => {
        this.querySelector('.like-count').textContent = data.like_count;
        this.classList.toggle('btn-primary', data.liked);
        this.classList.toggle('btn-outline-primary', !data.liked);
      });
  });
});
</script>
{% endblock %}